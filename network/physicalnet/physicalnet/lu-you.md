# 路由 {#4qsay5}

## IP选路 {#7tofa5}

![](/assets/network-phynetwork-basic-routeov.png)

1. 搜索路由表的优先级

   ```
    主机地址
    网络地址
    默认路由
   ```

2. 路由表

3. 如果找不到匹配的路由，则返回“主机不可达差错”或“网络不可达差错”

一个典型的路由表如下：

```
# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.0.0      0.0.0.0         255.255.192.0   U     0      0        0 eth0
0.0.0.0         192.168.0.1      0.0.0.0         UG    100    0        0 eth0
```

Flags各项的含义：

* U 该路由可用
* G 该路由是一个网关，如果没有该标志，则是直接路由
* H 该路由是一个主机，如果没有该标志，则是一个网络
* D 该路由是由重定向报文创建的
* M 该路由被ICMP重定向报文修改过

## 路由的修改 {#15jznr}

可以通过route命令来修改路由表，ICMP重定向报文也会修改路由表

一般在系统的配置文件中会设置默认路由.

## ICMP重定向差错 {#a8wzma}

当IP数据报应该被发送到另一个路由器时，收到数据报的路由器就要给发送端回复一个ICMP重定向差错报文。

重定向一般用来让具有很少选路信息的主机逐渐建立更完善的路由表。

## ICMP路由器发现报文 {#94qgha}

一般来说，主机在引导以后要广播或多播一份路由器请求报文，一台或多台路由器响应一份路由器通告报文。路由器也会定期地广播或多播路由器通告报文。

## 路由协议 {#a3f6um}

路由协议用来从多条路由路径中选择一条最佳的路径，并沿着这条路径将数据流产送到目的设备。

* 路由信息协议（RIP）：采用距离向量算法，收集所有可到达目的地的不同路径，并且保存有关到达每个目的地的最少站点数的路径信息，；同时路由器也把这些信息用RIP协议通知相邻路由器。RIP只适用于小型网络（最大15跳）。
* 开放式最短路径协议（OSPF）：基于链路状态，每个路由器向其同一管理域的所有其它路由器发送链路状态广播信息，并将自制域划分为区，并根据区的位置执行区内路由选择和区间路由选择。
* IS-IS：链路状态路由协议，和OSPF相同，IS-IS也使用了“区域”的概念，同样也维护着一份链路状态数据库，通过最短生成树算法（SPF）计算出最佳路径。
* 边界网关协议（BGP）：外部网关协议，用于与其它自治域的BGP交换网络可达信息（通过TCP确保可靠性）。

## 动态路由协议

动态路由协议，用在多个 Router 之间定期的、自动的、互相交换 Routes（路由信息，包含了网段信息、可达性信息、路径信息等），动态生成 Routing Table Entries，并最终达到全网的路由收敛，即：理想情况下，一个 Router 总是能够知道到达 IP Packets 的目标网络对应的下一跳应该如何转发。并且即便网络上的某个 Router 出现了故障，但只要有一个可绕行的其它路径，那么其他 Router 的 Table 就会自动设置，并选择一个可达的路径。

### 动态路由协议的基本工作原理

简而言之，动态路由协议就是 Routers 之间用于交换、计算和维护路由表的协议，其基本工作原理包括 4 个阶段：

1. **邻居发现阶段**
   ：运行了相同动态路由协议的 Routers 之间，首先需要建立一个用于交换 Routes 的对等点关系，这些 Routers 又称为 Neighbor Routers（邻居路由器）。
2. **路由交换阶段**
   ：发现邻居后，每个 Router 会主动通过广播或单薄的方式把自己的 Routes 发送给 Neighbor Routers。经过一段时间后，每个建立了对等点关系的 Routers 都拥有了整网的路由信息。
3. **计算路由阶段**
   ：每台 Router 都会自身的配置，运行各自的路由算法，计算出最终的路由表/树。
4. **维护路由阶段**
   ：为了感知突发的网络故障（例如；设备故障或线路中断等），Neighbor Routers 之间会发送周期性的心跳包，当心跳包超时时，就会认为邻居关系失效。此时 Router 需要自动维护路由表的更新，将故障路径移除。

### 动态路由协议的类型

**从应用场景角度划分**：

1. **IGP（Interior Gateway Protocol，内部网关协议）**
   ：作用于同一个 AS（Autonomous System，自治系统）内部的动态路由协议。在 AS 内的所有 Routers 之间交换 Routes，用于实现 AS 内部的 Routers 之间的三层路由可达性。例如：RIP、OSPF、I-BGP 协议。
2. **EGP（ Exterior Gateway Protocol，外部网关协议）**
   ：作用于不同 AS 之间的的动态路由协议。在不同 AS 之间的 Edge Routers（边界路由器）之间交换 Routes，用于实现 AS 之间的路径选择，所以也称为路径控制路由。例如：E-BGP 协议。

![](/assets/network-basic-route1.png)

**从技术实现角度划分**：

3.**Distance Vector（距离矢量类型）**

：是一种基于 “距离" 和 “方向" 的动态路由协议，如下图所示。该类型的路由协议有：RIP、BGP。

1. **距离**：指示了到达目的网络的度量值，即：所要经过路由器的个数。

2. **方向**：指示了到达目的网络的下一跳设备。

![](/assets/network-basic-route2.png)

1. **Link State（链路状态类型）**

2. ：是一种基于 LSDB（链路状态数据库）的动态路由协议。LSDB 中存储了 一张完整的网络拓扑图，绘制拓扑图的步骤如下。该类型的路由协议有：OSPF、ISIS。

3. 1. **LSA（Link State Advertisement，链路状态通告）泛洪**
      ：LSA Msg 中包含了 Router 已知的接口状态、接口 IP 地址、网络掩码、路由开销、网络类型等信息。每台 Router 都会将关于自身的本地直连链路的状态信息，以及将关于所有直连邻居的路由信息都宣告出去。
   2. **LSDB（Link State Database，链路状态数据库）建立**
      ：收到 LSA Msg 的 Router 都会根据 LSA 提供的信息建立本地的 LSDB，知道收敛后，网络中的所有的 LS Router 都应该具有了相同的 LSDB。
   3. **建立最短路径树**
      ：Router 在 LSDB 的基础上使用最短路由优先算法进行路由计算，得到一棵以自己为 Root（根）的、无环路的、可到达每个网络的最短路径树。
   4. **路由计算**
      ：通过最短路径树得出到达每个目的网络的最优 Routes，并将这些 Routes 加载到 Routing Table 中。

![](/assets/network-basic-route3.png)

可见，我们可以简单的理解为：Distance Vector 类型 Routes 提供的是 “路标”，那么 Link State 类型 Routes 提供的就是 “地图”。

### 常见的动态路由协议

![](/assets/network-basic-route4.png)

**1、RIP（IGP、距离矢量类型）**：是最早期的路由协议，为小型 IGP 网络提供。

* 配置简单；
* 网络收敛慢；
* 用于小型网络，现在常见于实验室环境。

**2、OSPFv3 和 ISIS（IGP、链路状态类型）**：为大中型 IGP 网络提供。

* IGP 整网地图绘制，可以精确的知道网络中每一条链路的状态，例如：状态是 UP 还是 Down，链路的相对带宽大小是多少等等。以此来保证了无环路，
* 使用最短路径优先算法来计算到达所有目的网络的最佳路径。
* 缺点在于分享的信息太多、太精确，安全性缺失，计算芯片负载高。

**3、BGPv4（IGP、EGP、距离矢量类型）**：最初为 EGP 广域网络提供，后来也可用于大型 IGP 网络。

* 作为 EGP 时，使用 AS 的数量作为距离度量单位，而不是使用 Router 的数量。
* 有强大的路径控制功能，例如：路由策略、路由过滤，可以对广域网的流量实现优化与调度。
* 设计之初，就是用于容纳超大容量的路由条目。

![](/assets/network-basic-route5.png)

### 动态路由协议的性能指标

不同的动态路由协议，具有有不同的特点。常规的性能指标如下：

1. **协议的路由计算正确性**
   ：杜绝出现路由环路。由于 Link State 类型具有整网地图，所以比 Distance Vector 类型更优。
2. **协议的路由收敛速度**
   ：整网路由器的路由表快速达到一致的状态。收敛速度越快，就意味着当网络拓扑结构发生变化时，路由器能够更快的感知到，并及时更新相应的路由信息。
3. **协议所占的系统开销**
   ：运行路由协议所占用的路由器系统资源，例如：CPU 、内存等。Link State 类型的开销大于 Distance Vector 类型。
4. **协议适用的网络规模**
   ：OSPF 的实现机制限定了其可以应用在几百台路由器的中大规模网络场景中；而 BGP 理论上能够管理全世界所有的路由器，其所管理的网络规模大小只受系统资源的限制。

## STP和Trill {#fuahl2}

为了提高网络的可靠性，交换网络通常会使用冗余链路，这会带来环路的风险。而STP和Trill就是为了解决环路问题而生的。

STP（Spanning Tree Protocol）的基本原理是在交换机之间传输BPDU（Bridge Protocol Data Unit）报文，并使用生成树来确定网络拓扑：

* 生成树初始化，建立根网桥
* 根端口选举，选择的依据是端口到根网桥的路径开销最小，如果路径开销相同则使用端口ID最小的端口
* 网段指定端口选举，选择的依据也是到根网桥路径开销最小
* 网络收敛后，只有指定端口和根端口可以转发数据。其他端口为预备端口，被阻塞，不能转发数据

STP最大的问题是二层链路利用率不足，且收敛慢，不适合大型数据中心。IETF又提出了Trill技术来克服STP的种种缺陷。Trill（TRansparent Interconnection of Lots of Links）的核心思想是将成熟的三层路由的控制算法引入到二层交换中，将原先的L2报文加一个新的封装\(隧道封装\)，转换到新的地址空间上进行转发。而新的地址有与IP类似的路由属性，具备大规模组网、最短路径转发、等价多路径、快速收敛、易扩展等诸多优势，从而规避STP/MSTP等技术的缺陷，实现健壮的大规模二层组网。支持TRILL技术的以太网交换机被称为`RBridge`。

# MPLS {#lebqm}

MPLS（Multi-Protocol Label Switching）利用标签进行数据转发，而不是向传统路由决策那样每次数据包进行解包，大大减少了路由决策的时间。当分组进入MPLS网络时，为其分配固定长度的短标记，并将标记与分组封装在一起，在整个转发过程中，交换节点仅根据标记进行转发。

