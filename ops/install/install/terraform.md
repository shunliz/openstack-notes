# Terraform

å®ƒçš„ä¸€ä¸ªé‡è¦åŠŸèƒ½ä¹‹ä¸€ï¼Œå°±æ˜¯è‡ªåŠ¨åŒ–åœ°ååŠ©ä½ äº‘\(å¤šäº‘\)åœºæ™¯ä¸‹çš„è‡ªåŠ¨åŒ–åŸºç¡€è®¾æ–½èµ„æºçš„ç®¡ç†ï¼ˆAWSã€è°·æ­Œäº‘ã€é˜¿é‡Œäº‘ç­‰ï¼‰ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥ä»¥å£°æ˜å¼çš„æ–¹å¼ï¼Œè‡ªåŠ¨åŒ–åœ°åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ä½ çš„å…¬æœ‰äº‘èµ„æºï¼Œå‡å°‘æ‰‹åŠ¨ç‚¹ç‚¹ç‚¹æ‰€å¸¦æ¥åœ°æ—¶é—´ä¸Šåœ°æ¶ˆè€—å’Œäººå·¥æ“ä½œä¸å¯é¿å…çš„é£é™©.

1. ä½¿ç”¨å£°æ˜å‹è¯­è¨€HCLï¼ˆHashiCorp Configuration Languageï¼‰ã€‚ä½¿ç”¨æˆ·åªå…³æ³¨ä¸è‡ªå·±çš„éœ€æ±‚ï¼Œè€Œéå¦‚ä½•å®ç°ï¼›
2. é‡‡ç”¨å®¢æˆ·ç«¯å•ä¸€æ¶æ„ï¼ˆClient Onlyï¼‰ï¼Œè€ŒéCSï¼ˆClient/Serverï¼‰æ¶æ„ã€‚é™ä½æ•°æ®å®‰å…¨é£é™©ï¼ŒåŒæ—¶æé«˜äº†infrastructureé…ç½®çš„å¯é æ€§ï¼›
3. å®Œå–„çš„å¼€æºç”Ÿæ€ã€‚åªéœ€è¦ä¸€ä¸ªå·¥å…·å³å¯å®Œæˆå¯¹å¤šä¸ªäº‘å‚å•†çš„æœåŠ¡è¿›è¡Œèµ„æºç¼–æ’ï¼›

4. è®¾è®¡ï¼ˆå’Œæµ‹è¯•ï¼‰åŸºç¡€è®¾æ–½ä¸€æ¬¡ï¼Œç„¶åå¤šæ¬¡é‡å¤ä½¿ç”¨è¯¥è®¾è®¡ã€‚

5. é…ç½®æ–‡ä»¶å¯ä»¥æ˜¯æºä»£ç æ§åˆ¶çš„ã€‚

6. åœ¨æ‚¨å– æ’å…¥é€‰æ‹©çš„é¥®æ–™çš„åŒæ—¶ï¼Œä½¿ç”¨å•ä¸ªå‘½ä»¤åˆ›å»ºå’Œç ´ååŸºç¡€è®¾æ–½ã€‚

7. ç›‘è§†çŠ¶æ€æ›´æ”¹ï¼ˆå¹¶å³æ—¶å®æ–½è®¾è®¡æ›´æ”¹ï¼‰ã€‚

Terraformå’ŒAnsibleåœ¨åˆè¯†æ—¶åº”è¯¥å¦‚ä½•å®šä½ä»–ä»¬ï¼Ÿå®ƒä»¬çš„å®šä½éƒ½æ˜¯è‡ªåŠ¨åŒ–çš„å·¥å…·ï¼Œåº”è¯¥å¦‚ä½•é€‰æ‹©ï¼Ÿ

å…¶å®Terraformå’ŒAnsibleæ˜¯æœ‰åŠŸèƒ½é‡å çš„ã€‚Terraformé…ç½®æ–‡ä»¶ä¸­çš„resourceå—ï¼Œæä¾›provisioneré…ç½®ï¼Œè¿æ¥åˆ°è¿œç¨‹ä¸»æœºå¹¶è¿›è¡Œç±»ä¼¼ansibleå¯æ‰§è¡Œçš„ç¯å¢ƒå‡†å¤‡çš„æ“ä½œã€‚

ä½†æ˜¯å¯ä»¥æ˜ç¡®çš„æ˜¯ï¼ŒTerraformç›®å‰æ›´åˆé€‚ä½ çš„åŸºç¡€è®¾æ–½åˆ›å»ºå’Œç®¡ç†ï¼Œå¦‚åˆ›å»ºä½ çš„äº‘ä¸»æœºã€è´Ÿè½½å‡è¡¡å™¨ç­‰ç­‰ï¼›Ansibleè€Œæ˜¯æ›´é€‚åˆä½ çš„äº‘ä¸»æœºåˆ›å»ºåï¼Œè‡ªåŠ¨åŒ–åœ°å»åˆå§‹åŒ–ä½ çš„æœºå™¨é…ç½®ã€å®‰è£…ç»„ä»¶ã€éƒ¨ç½²æœåŠ¡ç­‰ã€‚

# Terraformå¦‚ä½•å·¥ä½œï¼Ÿ

Terraformé€šè¿‡ç¤¾åŒºæˆ–è€…å…¶ä»–äººåœ¨Terraform Registryä¸Šå…¬å¼€çš„**provider**æ¥è°ƒç”¨äº‘å¹³å°æˆ–å„ç§æœåŠ¡çš„APIæ¥å£ï¼Œä»è€Œåˆ›å»ºå’Œç®¡ç†èµ„æºã€‚

![](/assets/other-deploy-terraform1.png)æ ¸å¿ƒ Terraform å·¥ä½œæµç¨‹åŒ…å«ä¸‰ä¸ªé˜¶æ®µï¼š

Write-ç¼–å†™ï¼šå®šä¹‰èµ„æºï¼Œç¼–å†™å£°æ˜å¼é…ç½®æ–‡ä»¶å®šä¹‰èµ„æºã€‚è¿™äº›èµ„æºå¯èƒ½è·¨è¶Šå¤šä¸ªäº‘æä¾›å•†å’ŒæœåŠ¡ã€‚

Plan-è®¡åˆ’ï¼š Terraform åˆ›å»ºä¸€ä¸ªæ‰§è¡Œè®¡åˆ’ï¼Œæè¿°å®ƒå°†æ ¹æ®ç°æœ‰åŸºç¡€æ¶æ„å’Œæ‚¨çš„é…ç½®åˆ›å»ºã€æ›´æ–°æˆ–é”€æ¯çš„åŸºç¡€æ¶æ„ã€‚

Apply-åº”ç”¨ï¼šåœ¨æ‰¹å‡†åï¼ŒTerraform ä¼šæŒ‰ç…§æ­£ç¡®çš„é¡ºåºæ‰§è¡Œå»ºè®®çš„æ“ä½œï¼Œå¹¶å°Šé‡ä»»ä½•èµ„æºä¾èµ–å…³ç³»ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æ›´æ–° VPC çš„å±æ€§å¹¶æ›´æ”¹è¯¥ VPC ä¸­çš„è™šæ‹Ÿæœºæ•°é‡ï¼ŒTerraform å°†åœ¨æ‰©å±•è™šæ‹Ÿæœºä¹‹å‰é‡æ–°åˆ›å»º VPCã€‚

![](/assets/other-deploy-terraform2.png)        _Terraformé»˜è®¤æƒ…å†µä¸‹åªç®¡ç†é€šè¿‡Terraformåˆ›å»ºå‡ºæ¥çš„èµ„æºã€‚ä½†æ˜¯å®é™…ç”Ÿäº§ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æœ‰äº†ä¸€äº›å…¬æœ‰äº‘çš„èµ„æºï¼Œæ‰å¼€å§‹è€ƒè™‘ä½¿ç”¨Terraformæ¥ç®¡ç†è¿™äº›èµ„æºã€‚_

_        å®é™…è¿™ç§åœºæ™¯ä¸‹ï¼Œéœ€è¦ä½¿ç”¨terrform importå°†éterraformåˆ›å»ºçš„èµ„æºè¿›è¡Œå¯¼å…¥ã€‚_

_        ä½†æ˜¯éº»çƒ¦çš„æ˜¯ï¼Œæ¯æ¬¡åªèƒ½å¯¼å…¥ä¸€ä¸ªèµ„æºã€‚ä¸”terraformç›®å‰åªæ¥å—è¿™ç§æ–¹å¼æ¥å¯¼å…¥èµ„æºï¼Œå¹¶ä¸èƒ½è‡ªåŠ¨è¯†åˆ«å¹¶ç”Ÿæˆç›¸å…³é…ç½®ã€‚      
_

# â­å…³é”®æ¦‚å¿µ

ğŸ’Configurationï¼šåŸºç¡€è®¾æ–½çš„å®šä¹‰å’Œæè¿°

åŸºç¡€è®¾æ–½å³ä»£ç ï¼Œå…¶ä¸­çš„ä»£ç Codeå°±æ˜¯å¯¹åŸºç¡€è®¾æ–½èµ„æºçš„ä»£ç å®šä¹‰å’Œæè¿°ï¼Œé€šè¿‡ä»£ç è¡¨è¾¾éœ€è¦ç®¡ç†çš„èµ„æºã€‚

æ‰€æœ‰èµ„æºçš„ä»£ç æè¿°éƒ½æ˜¯å®šä¹‰åœ¨ä¸€ä¸ªä»¥.tfç»“å°¾çš„æ–‡ä»¶ï¼Œç”¨äºterraformçš„åŠ è½½å’Œè§£æã€‚è¿™ä¸ªæ–‡ä»¶å°±ç§°ä¹‹ä¸ºâ€œTerraformæ¨¡æ¿â€æˆ–è€…â€œconfigurationâ€

ğŸ’Provider: åŸºç¡€è®¾æ–½ç®¡ç†ç»„ä»¶

Terraformå¸¸ç”¨äºå…¬æœ‰äº‘ä¸ŠåŸºç¡€è®¾æ–½çš„ç®¡ç†ï¼Œå¦‚è™šæ‹Ÿæœºã€ç½‘ç»œã€å®¹å™¨ç­‰ã€‚Providerå°±æ˜¯ä¸OpenAPIäº¤äº’çš„åç«¯é©±åŠ¨ï¼ŒTerraformé€šè¿‡Providerå®Œæˆå¯¹åŸºç¡€è®¾æ–½èµ„æºçš„ç®¡ç†ã€‚

æ¯ä¸ªåŸºç¡€è®¾æ–½æä¾›å•†ï¼Œaliyunã€awsç­‰éƒ½éœ€è¦æä¾›ä¸€ä¸ªprovideræ¥å®ç°å¯¹è‡ªå®¶èµ„æºçš„ç»Ÿä¸€ç®¡ç†ã€‚ç›®å‰æˆ‘ä»¬ä½¿ç”¨çš„é˜¿é‡Œäº‘å¯¹åº”çš„providerå°±æ˜¯alicloudã€‚

åœ¨è¿è¡Œç¯å¢ƒä¸­ï¼ŒTerraformå’ŒProvideræ˜¯ä¸¤ä¸ªç‹¬ç«‹å­˜åœ¨çš„packageï¼Œæ‰§è¡ŒTerraformæ—¶ï¼Œä¼šæ ¹æ®ç”¨æˆ·æ¨¡æ¿ä¸­æŒ‡å®šçš„Provideræˆ–è€…resource/datasourceçš„æ ‡å¿—è‡ªåŠ¨ä¸‹è½½æ¨¡æ¿ä½¿ç”¨çš„providerï¼Œå¹¶æ”¾åœ¨å½“å‰ç›®å½•ä¸‹çš„.terraforméšè—ç›®å½•ä¸‹ã€‚

ğŸ’Resourceï¼šåŸºç¡€è®¾æ–½èµ„æºå’ŒæœåŠ¡çš„ç®¡ç†

åœ¨Terraformä¸­ï¼Œä¸€ä¸ªå…·ä½“çš„èµ„æºæˆ–è€…æœåŠ¡ç§°ä¸ºresourceï¼Œæ¯”å¦‚ä¸€ä¸ªECSï¼Œä¸€ä¸ªSLBã€ä¸€ä¸ªåŸŸåè§£æè®°å½•ã€‚æ¯ä¸ªç‰¹å®šçš„resourceåŒ…å«äº†è‹¥å¹²å¯ç”¨äºæè¿°å¯¹åº”èµ„æºæˆ–æœåŠ¡çš„å±æ€§å­—æ®µã€‚é€šè¿‡è¿™äº›å­—æ®µæ¥å®šä¹‰ä¸€ä¸ªå®Œæ•´çš„èµ„æºæˆ–è€…æœåŠ¡ï¼Œæ¯”å¦‚dnsçš„domain\_nameã€ttlç­‰ã€‚

å¦‚ä¸‹å®šä¹‰ä¸€ä¸ªresourceï¼š

```
resource "alicloud_alidns_record" "dns701438486351555584" {
domain_name = "test.com"
line = "default"
priority = 0
rr = "mobile.api"
status = "ENABLE"
ttl = 600
type = "A"
value = "1.1.1.4"
}
```

å…¶ä¸­alicloud\_alidns\_recordä¸ºèµ„æºç±»å‹ï¼Œå®šä¹‰è¿™ä¸ªèµ„æºçš„ç±»å‹ï¼Œå‘Šè¯‰terraformè¿™ä¸ªresourceæ˜¯åŸŸåè§£æè®°å½•ã€‚

dns701438486351555584ä¸ºèµ„æºåç§°ï¼Œèµ„æºåç§°åœ¨åŒä¸€ä¸ªæ¨¡æ¿ä¸­å¿…é¡»å”¯ä¸€ï¼Œå¯ä»¥ç”¨äºå…¶ä»–èµ„æºå¼•ç”¨è¯¥èµ„æºã€‚

å¤§æ‹¬å·é‡Œé¢çš„blockä¸ºé…ç½®å‚æ•°ï¼Œå®šä¹‰èµ„æºçš„å±æ€§ã€‚

ğŸ’Data Sourceï¼šåŸºç¡€è®¾æ–½èµ„æºå’ŒæœåŠ¡çš„æŸ¥è¯¢

Data Sourceæä¾›æŸ¥è¯¢èµ„æºçš„åŠŸèƒ½ï¼Œæ¯ä¸ªdata sourceå®ç°å¯¹ä¸€ä¸ªèµ„æºçš„åŠ¨æ€æŸ¥è¯¢ï¼Œå…¶ç»“æœå¯ä»¥è®¤ä¸ºæ˜¯åŠ¨æ€å˜é‡ï¼Œåªæœ‰è¿è¡Œæ—¶æ‰çŸ¥é“å…¶å€¼ã€‚

```
data "alicloud_alidns_records" "records_ds_uni" {
domain_name = "test.com"
type = "A"
line = "unicom"
rr_regex = "mobile*.api"
output_file = "records-uni.txt"
}
```

å¦‚ä¸Šå®šä¹‰ä¸€ä¸ªrecords\_ds\_uniçš„èµ„æºï¼Œå…¶é€šè¿‡dataå¼•ç”¨ï¼ŒæŸ¥è¯¢test.comåŸŸåä¸‹ï¼Œè§£æè®°å½•åŒ¹é…mobile\*.apiçš„ï¼Œè§£æçº¿è·¯ä¸ºunicomçš„æ‰€æœ‰Aè®°å½•ï¼Œå¹¶è¾“å‡ºåˆ°records-uni.txtæ–‡æœ¬ä¸­ã€‚

ğŸ’stateï¼šä¿å­˜èµ„æºå…³ç³»ä»¥åŠå±æ€§æ–‡ä»¶çš„æ•°æ®åº“

Terraformåˆ›å»ºå’Œç®¡ç†æ‰€æœ‰èµ„æºéƒ½ä¿å­˜åœ¨è‡ªå·±çš„æ•°æ®åº“ä¸Šï¼Œè¿™ä¸ªæ•°æ®åº“æ˜¯ä¸€ä¸ªåä¸ºterraform.tfstateæ–‡ä»¶ï¼Œåœ¨terraformä¸­ç§°ä¹‹ä¸ºstateï¼Œé»˜è®¤å­˜æ”¾åœ¨æ‰§è¡Œå‘½ä»¤çš„æœ¬åœ°ç›®å½•ä¸­ã€‚

åœ¨æ‰§è¡Œterraformå‘½ä»¤æ—¶ï¼Œterraformä¼šåˆ©ç”¨stateæ–‡ä»¶ä¸æ¨¡æ¿æ–‡ä»¶è¿›è¡Œdiffå¯¹æ¯”ï¼Œå¦‚æœå‡ºç°ä¸ä¸€è‡´ï¼Œterraformå°†æŒ‰ç…§æ¨¡æ¿ä¸­çš„å®šä¹‰é‡æ–°åˆ›å»ºï¼Œæˆ–è€…ä¿®æ”¹èµ„æºï¼Œç›´åˆ°æ²¡æœ‰diffã€‚æ‰€ä»¥è¿™ä¸ªæ–‡ä»¶éå¸¸é‡è¦ï¼Œå¦‚æœæŸåï¼Œterraformå°†è®¤ä¸ºå·²åˆ›å»ºçš„èµ„æºè¢«ç ´åï¼Œæˆ–è€…éœ€è¦é‡å»ºã€‚å½“ç„¶å®é™…çš„äº‘èµ„æºä¸ä¼šæ”¶åˆ°å½±å“ã€‚

ğŸ’Backendï¼šå­˜å‚¨stateæ–‡ä»¶çš„è½½ä½“

å› terraformåˆ›å»ºèµ„æºåï¼Œä¼šå°†èµ„æºå±æ€§ä¿å­˜åœ¨stateæ–‡ä»¶ä¸­ï¼Œè€Œè¿™ä¸ªæ–‡ä»¶å¯ä»¥æ”¾æœ¬åœ°ï¼Œä¹Ÿå¯ä»¥å­˜æ”¾åœ¨è¿œç«¯ï¼Œå®ç°stateå’Œæ¨¡æ¿ä»£ç çš„åˆ†ç¦»ï¼Œè¿™ä¸ªå­˜æ”¾stateæ–‡ä»¶çš„è½½ä½“å°±æ˜¯backendã€‚

Backendåˆ†ä¸ºæœ¬åœ°å’Œremoteä¸¤ç±»ï¼Œé»˜è®¤ä¸ºæœ¬åœ°ã€‚ç›®å‰å·²æ”¯æŒå¤šè¾¾13ä¸­è¿œç«¯å­˜å‚¨æ–¹æ¡ˆï¼Œå¦‚consoleã€etcdã€ossç­‰ï¼Œå¯ä»¥é™ä½å¤šäººåä½œå¯¹stateç»´æŠ¤çš„æˆæœ¬ï¼Œä¹Ÿå¯ä»¥ä¿éšœæ•°æ®çš„å®‰å…¨æ€§ã€‚

ğŸ’Provisionerï¼šåœ¨æœºå™¨ä¸Šæ‰§è¡Œæ“ä½œçš„ç»„ä»¶

ç”¨æ¥åœ¨æœ¬åœ°æœºå™¨æˆ–è€…ç™»å½•è¿œç¨‹ä¸»æœºæ‰§è¡Œç›¸å…³çš„æ“ä½œï¼Œå¦‚local-execåœ¨æœ¬åœ°æ‰§è¡Œå‘½ä»¤ï¼Œchefç”¨æ¥åœ¨è¿œç¨‹ä¸»æœºå®‰è£…ã€é…ç½®ã€æ‰§è¡Œchef clientï¼Œremote-execç”¨æ¥ç™»å½•è¿œç¨‹ä¸»æœºæ‰§è¡Œå‘½ä»¤ã€‚

é€šå¸¸ä¸provideræ­é…å®ç°ï¼Œprovideråˆ›å»ºèµ„æºåï¼Œä½¿ç”¨provisioneråœ¨åˆ›å»ºçš„èµ„æºä¸Šæ‰§è¡Œå„ç§æ“ä½œã€‚

# ğŸ’å¸¸ç”¨å‘½ä»¤

terraform init: åˆå§‹åŒ–ï¼ŒåŠ è½½æ‰€éœ€æ¨¡å—

terraform planï¼š èµ„æºé¢„è§ˆ

ç”¨äºå¯¹æ¨¡æ¿å®šä¹‰çš„èµ„æºè¿›è¡Œé¢„è§ˆã€‚å¦‚é¢„è§ˆå½“å‰æ¨¡æ¿ä¸­å®šä¹‰çš„èµ„æºæ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œå¦‚æœå­˜åœ¨stateæ–‡ä»¶åˆ™å±•ç¤ºdiffç»“æœï¼Œå³å˜æ›´çš„å†…å®¹ã€‚

terraform applyï¼šæ–°å»ºã€å˜æ›´èµ„æº

terraform showï¼šèµ„æºå±•ç¤ºï¼Œå±•ç¤ºå½“å‰stateä¸­æ‰€ç®¡ç†çš„èµ„æºä»¥åŠæ‰€æœ‰å±æ€§

terraform destroyï¼š èµ„æºé‡Šæ”¾

terraform importï¼š èµ„æºå¯¼å…¥ï¼Œå°†å­˜é‡çš„äº‘èµ„æºå¯¼å…¥åˆ°stateä¸­ï¼Œè¿›è€ŒåŠ å…¥åˆ°terraformçš„ç®¡ç†ä½“ç³»ä¸­ã€‚é€‚ç”¨ä»¥ä¸‹åœºæ™¯ï¼š

ä»æ¥æ²¡ä½¿ç”¨terraformç®¡ç†è¿‡èµ„æºï¼Œç°åœ¨éœ€è¦åˆ‡æ¢åˆ°terraformç®¡ç†ï¼›

åœ¨ä¸å½±å“èµ„æºä½¿ç”¨çš„å‰æä¸‹ï¼Œé‡æ„èµ„æºæ¨¡æ¿ä¸­çš„å®šä¹‰ï¼›

Provideræœ‰å‡çº§æ”¯æŒäº†æ›´å¤šçš„å‚æ•°ï¼Œéœ€è¦æŠŠæ–°å‚æ•°åŒæ­¥è¿‡æ¥ã€‚

terraform fmtï¼š æ ¼å¼åŒ–æ¨¡æ¿æ–‡ä»¶ã€‚å°†ç¼–å†™çš„tfæ–‡ä»¶è¿›è¡Œå°±åœ°æ ¼å¼åŒ–ã€‚

![](/assets/other-deploy-terraform3.png)

# æ“ä½œçš„ç”Ÿå‘½å‘¨æœŸ

![](/assets/other-deploy-terraform4.png)

èµ„æºç¼–æ’çš„åŠ¨ä½œçš„ç”Ÿå‘½å‘¨æœŸå¦‚ä¸Šï¼Œå…¶ä¸­å·¦ä¾§ä¸ºTerraformç³»ç»Ÿç³»ç»Ÿçš„èƒ½åŠ›ï¼Œå³ä¾§providerã€provisionerä¸ºå‚å•†æä¾›ã€‚

å½“æ‰§è¡Œterraform applyå‘½ä»¤æ—¶ï¼š

â‘ ã€terraformå”¤é†’è¿›ç¨‹ï¼Œåˆå§‹åŒ–backend\(é»˜è®¤ä¸ºlocal-file\)ï¼›

â‘¡ã€è§£æç”¨æˆ·å®šä¹‰çš„æ¨¡æ¿æ–‡ä»¶ï¼Œå¹¶è·å–æœ€æ–°çš„èµ„æºçŠ¶æ€ï¼Œè¿›è¡Œå¯¹æ¯”ï¼›

â‘¢ã€æ„å»ºDAGï¼Œå°†æ‰€æœ‰ç¼–æ’åŠ¨ä½œä¾æ¬¡å‘é€ç»™providerï¼›

â‘£ã€providerè°ƒç”¨äº‘APIç®¡ç†äº‘èµ„æº

â‘¤ã€å°†è¿”å›çš„ç»“æœå†™å›state

# å®ä¾‹ï¼ˆTerraform è°ƒç”¨Ansibleï¼‰

```
provider "aws" {
  region  = "us-west-2"
}
 
resource "tls_private_key" "key" {
  algorithm = "RSA"
}
 
resource "local_file" "private_key" {
  filename          = "${path.module}/ansible-key.pem"
  sensitive_content = tls_private_key.key.private_key_pem
  file_permission   = "0400"
}
 
resource "aws_key_pair" "key_pair" {
  key_name   = "ansible-key"
  public_key = tls_private_key.key.public_key_openssh
}
 
data "aws_vpc" "default" {
  default = true
}
 
resource "aws_security_group" "allow_ssh" {
  vpc_id = data.aws_vpc.default.id
 
  ingress {
    from_port   = 22
    to_port     = 22
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
 
  ingress {
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
 
  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}
 
data "aws_ami" "ubuntu" {
  most_recent = true
 
  filter {
    name   = "name"
    values = ["ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*"]
  }
 
  owners = ["099720109477"]
}
 
resource "aws_instance" "ansible_server" {
  ami                    = data.aws_ami.ubuntu.id
  instance_type          = "t3.micro"
  vpc_security_group_ids = [aws_security_group.allow_ssh.id]
  key_name               = aws_key_pair.key_pair.key_name
 
  tags = {
    Name = "Ansible Server"
  }
 
  provisioner "remote-exec" {
    inline = [
      "sudo apt update -y",
      "sudo apt install -y software-properties-common",
      "sudo apt-add-repository --yes --update ppa:ansible/ansible",
      "sudo apt install -y ansible"
    ]
 
    connection {
      type        = "ssh"
      user        = "ubuntu"
      host        = self.public_ip
      private_key = tls_private_key.key.private_key_pem
    }
  }
 
  provisioner "local-exec" {
    command = "ansible-playbook -u ubuntu --key-file ansible-key.pem -T 300 -i '${self.public_ip},', app.yml" 
  }
}
 
output "public_ip" {
 value = aws_instance.ansible_server.public_ip
}
 
output "ansible_command" {
    value = "ansible-playbook -u ubuntu --key-file ansible-key.pem -T 300 -i '${aws_instance.ansible_server.public_ip},', app.yml"
}
```



